<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yc.bean.FileuploadMapper">

	<cache type="org.mybatis.caches.ehcache.LoggingEhcache">
	</cache>

	<sql id="orderSql">
		<if test="orderby!=null and orderby!=''">
			order by #{orderby}
			<if test="orderway!=null and orderway!=''">
				#{orderway}
			</if>
		</if>
	</sql>

	<!-- 分页条件的拼接 -->
	<sql id="pageSql">
		<if test="start!=null">
			limit #{start},#{pagesize}
		</if>
	</sql>

	<insert id="addFile" parameterType="Fileupload"
		useGeneratedKeys="true" keyProperty="fid">
		insert into
		file(fname,description,path,uid,uptime,downtimes,fweight,todid,togid,touid,fstatus)
		values(#{fname},#{description},#{path},#{uid},now(),0,#{fweight},#{todid},#{togid},#{touid},#{fstatus})
	</insert>



	<select id="findFile" parameterType="Fileupload" resultType="Fileupload">
		select
		fid,fname,description,path,file.uid,a.uname as uname,uptime,downtimes,fweight,touid,togid,todid,fstatus
		from file left join (select uid,uname from users) a on a.uid = file.uid where fstatus = 1
		
			<if test="timefrom!=null and timefrom!=''">
				and uptime >#{timefrom}
			</if>
			<if test="timeto!=null and timeto!=''">
				and #{timeto}>uptime
			</if>
			<if test="fname!=null and fname!=''">
				and fname like '%${fname}%'
			</if>
		
		<include refid="orderSql" />
		<include refid="pageSql" />
		
	</select>



	<!-- 查找文件数量 -->
	<select id="FileCount" resultType="int" parameterType="Fileupload">
		select count(*) from file
		<where>
			<if test="timefrom!=null and timefrom!=''">
				and uptime >#{timefrom}
			</if>
			<if test="timeto!=null and timeto!=''">
				and #{timeto}>uptime
			</if>
			<if test="fname!=null and fname!=''">
				and fname like '%${fname}%'
			</if>
		</where>
	</select>


	<select id="findFilefordownload" parameterType="Fileupload" resultType="Fileupload">
	select
	fid,fname,description,path,uid,uptime,downtimes,fweight,touid,togid,todid
	from file where fid = #{fid}
	</select>
	
	<!--  查找发给自己的文件或本部门的文件 -->
	<select id="sendMeFile" parameterType="Fileupload" resultType="Fileupload">
	select a.fid as fid ,a.fname as fname,a.description as description,a.uptime as uptime,
	a.downtimes as downtimes,a.uid as uid,u.uname as uname from		
	(select  fid,fname,description,uptime,downtimes,file.uid as uid,uname from  file 
	inner join  users on    ( todid=did  and  ISNULL(togid) and ISNULL(touid))
	or (todid =did  and togid=gid and ISNULL(touid)) 
	or (todid = did and togid =gid  and touid=users.uid) where 
	users.uid=#{touid}) a left join users u on a.uid=u.uid where 1=1
		
		<include refid="orderSql" />
		<include refid="pageSql" />
	</select>
	
	<!--  查找发给自己的文件或本部门的文件-->
	<select id="sendMeFileCount" parameterType="Fileupload" resultType="int">
			select  count(*) from  file 
		inner join  users on    ( todid=did  and  ISNULL(togid) and ISNULL(touid))
		or (todid =did  and togid=gid and ISNULL(touid)) 
		or (todid = did and togid =gid  and touid=users.uid) where
		users.uid=#{touid}
		 
	</select> 
	<!-- 更新下载次数 -->
	<update id="updatedownloadtimes" parameterType="Fileupload">
		update file set downtimes = downtimes+1 where fid = #{fid}
	</update>

	<!-- 删除 -->
	<delete id="deleteFile" parameterType="Fileupload">
		delete from file where fid=#{fid}
	</delete>


</mapper>